name: CI - Maven Test

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Locate pom.xml
        id: pom
        shell: bash
        run: |
          POM=$(git ls-files | grep -E '(^|/)+pom\.xml$' | head -n1)
          if [ -z "$POM" ]; then
            echo "No pom.xml found"; exit 1
          fi
          echo "pom=$POM" >> "$GITHUB_OUTPUT"
          echo "dir=$(dirname "$POM")" >> "$GITHUB_OUTPUT"
          echo "Found POM at: $POM"

      - name: Build & Test
        run: mvn -B -f "${{ steps.pom.outputs.pom }}" clean test

      - name: Snyk Open Source (Maven)
        id: snyk_maven
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: >-
            --file=${{ steps.pom.outputs.pom }}
            --severity-threshold=medium
            --sarif-file-output=snyk.sarif

      - name: Debug
        run: |
          pwd
          ls -la
          echo "Expected SARIF at: $GITHUB_WORKSPACE/snyk.sarif"
          test -f snyk.sarif && echo "SARIF exists" || (echo "SARIF missing"; exit 0)

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && hashFiles('snyk.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk.sarif

      - name: Build Docker image (CI)
        run: docker build -t simplecalculate:ci "${{ steps.pom.outputs.dir }}"

      - name: Smoke test container
        run: docker image inspect simplecalculate:ci
